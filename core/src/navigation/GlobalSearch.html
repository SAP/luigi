<div
  class="fd-shellbar__action {!isMobile ? 'fd-shellbar__action--desktop':'fd-shellbar__action--mobile'}"
>
  <div class="fd-popover__control" on:click|stopPropagation="{() => {}}">
    <div
      aria-hidden="{!isMobile ? (!(dropDownStates.globalSearchPopover || dropDownStates.showResultAndSearchField)) : (!(dropDownStates.globalSearchMobilePopover  || false))}"
      aria-haspopup="true"
      class="luigi-search"
    >
      <div class="fd-input-group fd-shellbar__input-group">
        <input
          type="text"
          id="luigi-globalSearch"
          class="fd-input fd-input-group__input fd-shellbar__input-group__input luigi-input-search-field"
        >
      </div>
    </div>

    <div
      class="fd-popover__body fd-popover__body--right"
      aria-hidden="{!dropDownStates.showResultAndSearchField}"
    >
      {#if searchResults}
      <nav class="fd-menu">
        <ul class="fd-menu__list fd-menu__list--top">
          {#each searchResults as result}
          <li class="fd-menu__item" on:click="{clearInputField}">{result}</li>
          {/each}
        </ul>
      </nav>
      {/if}
    </div>
  </div>
</div>
{#if !isMobile}
<div class="fd-shellbar__action fd-shellbar__action--desktop">
  <div on:click|stopPropagation="{() => {}}">
    <button
      class="fd-button fd-shellbar__button sap-icon--search"
      id="lui-search-button"
      aria-haspopup="true"
      aria-expanded="{dropDownStates.globalSearchPopover || false}"
      on:click="{() => toggleDropdownState('globalSearchPopover')}"
    ></button>
  </div>
</div>
{/if}
<!-- {#if isMobile}
<div class="fd-shellbar__action fd-shellbar__action--mobile">
  <div class="fd-popover__control" on:click|stopPropagation="{() => {}}">
    <div
      aria-label="LuigiGlobalSearch"
      aria-hidden="{!(dropDownStates.globalSearchMobilePopover  || false)}"
      aria-haspopup="true"
      class="luigi-search"
    >
      <div class="fd-input-group fd-shellbar__input-group">
        <input
          type="text"
          id="luigi-globalSearch"
          class="fd-input fd-input-group__input fd-shellbar__input-group__input luigi-input-search-field-mobile"
        >
      </div>
    </div>
  </div>
</div>
{/if}-->
<script>
  import { beforeUpdate, createEventDispatcher, onMount } from 'svelte';
  import { LuigiAuth, LuigiConfig } from '../core-api';
  import { GenericHelpers } from '../utilities/helpers';
  export let dropDownStates = {};
  export let isMobile;
  const dispatch = createEventDispatcher();
  let showResultAndSearchField = false;
  let searchResults = {};
  let search;
  onMount(async () => {
    search = await LuigiConfig.getConfigValueAsync('globalSearch.search');
  });

  beforeUpdate(() => {
    if (search && GenericHelpers.isFunction(search.customSearch)) {
      const input = document.getElementById('luigi-globalSearch');
      input.addEventListener('keyup', e => {
        //TODO security validation
        search.customSearch(e).then(results => {
          if (results) {
            searchResults = results;
            toggleDropdownState('showResultAndSearchField');
          }
        });
      });
    }
  });

  export function toggleDropdownState(name) {
    dispatch('toggleDropdownState', { name });
  }

  function clearInputField() {
    const input = document.getElementById('luigi-globalSearch');
    input.value = '';
  }
</script>
<style type="text/scss">
  :global(.luigi-search) {
    &[aria-hidden='true'] {
      display: none !important;
    }
  }
</style>
