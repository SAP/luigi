<svelte:window
  on:click="closeAllDropdowns()"
  on:blur="closeAllDropdowns()"
  on:resize="onResize()"
/>
{#if children && pathData.length > 1}
<nav
  class="fd-tabs {hideNavComponent ? 'fd-tabs-fullscreen' : ''} {tabsfullscreen?'fd-tabs-fullscreen':''}"
  role="tablist"
  id="tabsContainer"
  on:toggleDropdownState="toggleDropdownState(event.name)"
>
  {#each Object.entries(children) as [key, nodes]}
  {#if key === 'undefined' || key.indexOf(virtualGroupPrefix) === 0}
  {#each nodes as node}
  {#if !node.hideFromNav}
  {#if node.label}
  <span
    class="fd-tabs__item"
  >
    <a
      class="fd-tabs__link"
      href="javascript:void(null)"
      role="tab"
      aria-selected="{node === selectedNode}"
      on:click="handleClick(node)"
    >{node.label}</a>
  </span>
  {/if}
  {/if}
  {/each}
  {:else}
  <span
    class="fd-tabs__item {manipulateKey(key)}"
    on:click="event.stopPropagation()"
  >
    <div class="fd-popover">
      <a
        class="fd-tabs__link has-child"
        aria-expanded="false"
        href="javascript:void(null)"
        role="tab"
        on:click="toggleDropdownState(key)"
        aria-selected="{selectedNode && selectedNode.category && (selectedNode.category === key || selectedNode.category.label === key)}"
      >
        <span class="label">{key}</span>
        <span class="sap-icon--dropdown sap-icon--l"></span>
      </a>
      <div
        class="fd-popover__body fd-popover__body--no-arrow"
        aria-hidden="{!dropDownStates[key]}"
      >
        <nav class="fd-menu" id>
          <ul class="fd-menu__list">
            {#each nodes as node}
            {#if !node.hideFromNav}
            {#if node.label}
            <li>
              <a
                href="javascript:void(null)"
                class="fd-menu__item"
                on:click="handleClick(node)"
                aria-selected="{node === selectedNode}"
              >{node.label}</a>
            </li>
            {/if}
            {/if}
            {/each}
          </ul>
        </nav>
      </div>
    </div>
  </span>
  {/if}
  {/each}
  <span
    class="fd-tabs__item more"
    on:click="event.stopPropagation()"
  >
    <div class="fd-popover fd-popover--right">
      <a
        class="fd-tabs__link fd-popover__control has-child"
        aria-expanded="false"
        href="javascript:void(null)"
        role="tab"
        on:click="toggleDropdownState(key)"
        aria-selected="{false && selectedNode.category && (selectedNode.category === key || selectedNode.category.label === key)}"
      >
        <span class="label">More</span>
        <span class="sap-icon--dropdown sap-icon--l"></span>
      </a>
      <div
        class="fd-popover__body fd-popover__body--right fd-popover__body--no-arrow"
        aria-hidden="{!dropDownStates[key]}"
      >
        <nav class="fd-menu" id>
          <!-- <ul class="fd-menu__list"> -->
          {#each Object.entries(children) as [key, nodes]}
          {#if key === 'undefined' || key.indexOf(virtualGroupPrefix) === 0}
          {#each nodes as node}
          {#if node.displayInMoreBtn}
          <li>
            <a
              href="javascript:void(null)"
              class="fd-menu__item"
              on:click="handleClick(node)"
              aria-selected="true"
            >{node.label}</a>
          </li>
          {/if}
          {/each}
          {:else}
          {#each nodes as node}
          {#if node.displayInMoreBtn}
          <li>
            <a
              href="javascript:void(null)"
              class="fd-menu__item"
              on:click="handleClick(node)"
              aria-selected="true"
            >{key}</a>
          </li>
          {/if}
          {/each}
          {/if}
          {/each}
          <!-- </ul> -->
        </nav>
      </div>
    </div>
  </span>
</nav>
{/if}
<script type="text/javascript">
  import { Navigation } from './services/navigation';
  import { NavigationHelpers, StateHelpers } from '../utilities/helpers';
  import { LuigiConfig } from '../core-api';

  const setTabNavData = async (current, component) => {
    const componentData = component.get();
    const tabNavData = await Navigation.getTabNavData(current, componentData);
    if (!tabNavData) {
      return;
    }
    component.set(tabNavData);
    calcTabsContainer(component);
    window['LEFTNAVDATA'] = tabNavData.groupedChildren;
  };

  const calcTabsContainer = component => {
    let tabsContainer = document.getElementById('tabsContainer');
    let tabsContainerTotalWidth;
    let tabsContainerDisplayWidth;
    let tabsContainerOffsetWidth;
    let totalTabsSize = 0;
    let notDisplayedElements = [];
    let moreItem;
    let moreItemWidth;
    if (tabsContainer) {
      //clientWidth, offsetWidth, scrollWidth
      tabsContainerTotalWidth = tabsContainer.scrollWidth;
      tabsContainerDisplayWidth = tabsContainer.clientWidth;
      tabsContainerOffsetWidth = tabsContainer.offsetWidth;
      let tabs = tabsContainer.children;
      moreItem = tabs[tabs.length - 1];
      moreItemWidth = moreItem.scrollWidth;
      let nodesInMore = component.get().children;
      tabs.forEach(element => {
        totalTabsSize += element.scrollWidth;
        if (
          totalTabsSize > tabsContainerOffsetWidth - moreItemWidth - 320 &&
          element !== moreItem
        ) {
          element.classList.add('hide_element');
          for (let [key, nodes] of Object.entries(nodesInMore)) {
            nodes.forEach(node => {
              if (
                key !== 'undefined' &&
                key.indexOf(NavigationHelpers.virtualGroupPrefix) !== 0
              ) {
                if (
                  element.classList.contains(
                    key
                      .split(' ')
                      .join('')
                      .toLowerCase()
                  ) &&
                  element.classList.contains('hide_element')
                ) {
                  node['displayInMoreBtn'] = true;
                }
              } else if (element.innerText === node.label) {
                node['displayInMoreBtn'] = true;
              }
            });
          }
        } else {
          element.classList.remove('hide_element');
          for (let [key, nodes] of Object.entries(nodesInMore)) {
            nodes.forEach(node => {
              if (
                key !== 'undefined' &&
                key.indexOf(NavigationHelpers.virtualGroupPrefix) !== 0
              ) {
                element.classList.forEach(elem => {
                  if (elem === 'tabnav' + key) {
                    node['displayInMoreBtn'] = false;
                  }
                });
              } else if (element.innerText === node.label) {
                node['displayInMoreBtn'] = false;
              }
            });
          }
        }
      });
      component.set({ children: nodesInMore });
    }
  };

  export default {
    oncreate() {
      this.set({
        hideNavComponent: LuigiConfig.getConfigBooleanValue(
          'settings.hideNavigation'
        )
      });
    },
    onstate({ changed, current, previous }) {
      if (!previous || previous.pathData != current.pathData) {
        let lastNode = [...current.pathData].pop();
        if (lastNode.hideSideNav) {
          this.set({ tabsfullscreen: true });
        } else {
          this.set({ tabsfullscreen: false });
        }
        setTabNavData(current, this);
      }
    },
    data() {
      return {
        dropDownStates: {},
        virtualGroupPrefix: NavigationHelpers.virtualGroupPrefix
      };
    },
    helpers: {
      isOpenUIiconName(name) {
        return NavigationHelpers.isOpenUIiconName(name);
      },
      isExpanded(nodes, expandedList) {
        return (
          expandedList && expandedList.indexOf(nodes.metaInfo.categoryUid) >= 0
        );
      },
      manipulateKey(key) {
        return key
          .split(' ')
          .join('')
          .toLowerCase();
      }
    },
    methods: {
      handleClick(node) {
        this.closeAllDropdowns();
        this.fire('handleClick', { node });
      },

      toggleDropdownState(name) {
        let dropDownStates = {};
        if (!this.get().dropDownStates[name]) {
          dropDownStates[name] = true;
        }
        this.set({ dropDownStates: dropDownStates });
      },
      closeAllDropdowns() {
        this.set({ dropDownStates: {} });
      },
      onResize() {
        calcTabsContainer(this);
      }
    }
  };
</script>

<style type="text/scss">
  .fd-tabs__link.has-child .label {
    padding-right: 17px;
  }

  :global(.hide_element) {
    display: none;
  }

  .fd-tabs__link.has-child .sap-icon--l {
    position: absolute;
    top: 0.7em;
    right: 0;
  }

  .fd-tabs__item.more {
    /* position: absolute; */
    right: 0;
  }

  .fd-tabs-fullscreen {
    left: 0 !important;
  }

  .fd-tabs {
    flex-wrap: nowrap;
    white-space: nowrap;
    -moz-box-shadow: 1px 1px 2px 0 rgba(0, 0, 0, 0.05);
    -webkit-box-shadow: 1px 1px 2px 0 rgba(0, 0, 0, 0.05);
    box-shadow: 1px 1px 2px 0 rgba(0, 0, 0, 0.05);
    border: none;
    position: fixed;
    width: 100%;
    left: 320px;
  }
</style>
