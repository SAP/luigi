<svelte:window on:click="closeAllDropdowns()" on:blur="closeAllDropdowns()"/>
{#if children && pathData.length > 1}
<nav
  class="fd-tabs {hideNavComponent ? 'fd-tabs-fullscreen' : ''} {tabsfullscreen?'fd-tabs-fullscreen':''}"
  role="tablist"
  on:toggleDropdownState="toggleDropdownState(event.name)"
>
  {#each Object.entries(children) as [key, nodes]}
  {#if key === 'undefined' || key.indexOf(virtualGroupPrefix) === 0}
  {#each nodes as node}
  {#if !node.hideFromNav}
  {#if node.label}
  <span
    class="fd-tabs__item"
  >
    <a
      class="fd-tabs__link"
      href="javascript:void(null)"
      role="tab"
      aria-selected="{node === selectedNode}"
      on:click="handleClick(node)"
    >{node.label}</a>
  </span>
  {/if}
  {/if}
  {/each}
  {:else}
  <span
    class="fd-tabs__item"
    on:click="event.stopPropagation()"
  >
    <div class="fd-popover">
      <a
        class="fd-tabs__link has-child"
        aria-expanded="false"
        href="javascript:void(null)"
        role="tab"
        on:click="toggleDropdownState(key)"
        aria-selected="{selectedNode && selectedNode.category && (selectedNode.category === key || selectedNode.category.label === key)}"
      >
        <span class="label">{key}</span>
        <span class="sap-icon--dropdown sap-icon--l"></span>
      </a>
      <div
        class="fd-popover__body fd-popover__body--no-arrow"
        aria-hidden="{!dropDownStates[key]}"
      >
        <nav class="fd-menu" id>
          <ul class="fd-menu__list">
            {#each nodes as node}
            {#if !node.hideFromNav}
            {#if node.label}
            <li>
              <a
                href="javascript:void(null)"
                class="fd-menu__item"
                on:click="handleClick(node)"
                aria-selected="{node === selectedNode}"
              >{node.label}</a>
            </li>
            {/if}
            {/if}
            {/each}
          </ul>
        </nav>
      </div>
    </div>
  </span>
  {/if}
  {/each}
  <span
    class="fd-tabs__item more"
    on:click="event.stopPropagation()"
  >
    <div class="fd-popover fd-popover--right">
      <a
        class="fd-tabs__link fd-popover__control has-child"
        aria-expanded="false"
        href="javascript:void(null)"
        role="tab"
        on:click="toggleDropdownState(key)"
        aria-selected="{false && selectedNode.category && (selectedNode.category === key || selectedNode.category.label === key)}"
      >
        <span class="label">More</span>
        <span class="sap-icon--dropdown sap-icon--l"></span>
      </a>
      <div
        class="fd-popover__body fd-popover__body--right fd-popover__body--no-arrow"
        aria-hidden="{!dropDownStates[key]}"
      >
        <nav class="fd-menu" id>
          <ul class="fd-menu__list">
            <li>
              <a
                href="javascript:void(null)"
                class="fd-menu__item"
                on:click="handleClick(node)"
                aria-selected="true"
              >tets</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </span>
</nav>
{/if}
<script type="text/javascript">
  import { Navigation } from './services/navigation';
  import { NavigationHelpers, StateHelpers } from '../utilities/helpers';
  import { LuigiConfig } from '../core-api';

  const setLeftNavData = async (current, component) => {
    const componentData = component.get();
    const leftNavData = await Navigation.getTabNavData(current, componentData);
    if (!leftNavData) {
      return;
    }
    component.set(leftNavData);
    window['LEFTNAVDATA'] = leftNavData.groupedChildren;
  };

  export default {
    oncreate() {
      this.set({
        hideNavComponent: LuigiConfig.getConfigBooleanValue(
          'settings.hideNavigation'
        )
      });
    },
    onstate({ changed, current, previous }) {
      if (!previous || previous.pathData != current.pathData) {
        let lastNode = [...current.pathData].pop();
        if (lastNode.hideSideNav) {
          this.set({ tabsfullscreen: true });
        } else {
          this.set({ tabsfullscreen: false });
        }
        setLeftNavData(current, this);
      }
    },
    data() {
      return {
        dropDownStates: {},
        virtualGroupPrefix: NavigationHelpers.virtualGroupPrefix
      };
    },
    helpers: {
      isOpenUIiconName(name) {
        return NavigationHelpers.isOpenUIiconName(name);
      },
      isExpanded(nodes, expandedList) {
        return (
          expandedList && expandedList.indexOf(nodes.metaInfo.categoryUid) >= 0
        );
      }
    },
    methods: {
      handleClick(node) {
        this.closeAllDropdowns();
        this.fire('handleClick', { node });
      },

      toggleDropdownState(name) {
        let dropDownStates = {};
        if (!this.get().dropDownStates[name]) {
          dropDownStates[name] = true;
        }
        this.set({ dropDownStates: dropDownStates });
      },

      closeAllDropdowns() {
        this.set({ dropDownStates: {} });
      }
    }
  };
</script>

<style type="text/scss">
  .fd-tabs__link.has-child .label {
    padding-right: 17px;
  }

  .fd-tabs__link.has-child .sap-icon--l {
    position: absolute;
    top: 0.7em;
    right: 0;
  }

  .fd-tabs__item.more {
    position: absolute;
    right: 0;
  }

  .fd-tabs-fullscreen {
    left: 0 !important;
  }

  .fd-tabs {
    flex-wrap: nowrap;
    white-space: nowrap;
    -moz-box-shadow: 1px 1px 2px 0 rgba(0, 0, 0, 0.05);
    -webkit-box-shadow: 1px 1px 2px 0 rgba(0, 0, 0, 0.05);
    box-shadow: 1px 1px 2px 0 rgba(0, 0, 0, 0.05);
    border: none;
    position: fixed;
    width: 100%;
    left: 320px;
  }
</style>
