<svelte:window on:click="{closeSearchResult}" on:blur="{closeSearchResult}"/>
<div class="fd-shellbar__action lui-global-search-input {isSearchFieldVisible?'lui-global-search-mobile--active':''}">
  <div class="fd-popover">
    <div
      class="fd-popover__control luigi-search"
      on:click|stopPropagation="{() => {}}"
      aria-hidden="{!isSearchFieldVisible}"
      aria-haspopup="true"
    >
      <div class="fd-input-group fd-shellbar__input-group">
        {#if search && search.disableInputHandlers}
        <input
          type="text"
          class="fd-input fd-input-group__input fd-shellbar__input-group__input luigi-search__input"
          data-testid="luigi-search-input__no-handlers"
          autofocus
        />
        {:else}
        <input
          type="text"
          on:keyup="{(event) => onKeyUp(event)}"
          class="fd-input fd-input-group__input fd-shellbar__input-group__input luigi-search__input"
          data-testid="luigi-search-input"
          autofocus
          bind:this="{inputElem}"
        />
        {#if search.searchFieldCentered}
        <span
          class="fd-input-group__addon fd-shellbar__input-group__addon fd-input-group__addon--button"
        >  
          <button
            aria-label="button-decline"
            class="fd-shellbar__button fd-button"
            on:click="{clearSearchField}"
          >
            {#if clearSearchFieldBtn}
              <i class="sap-icon--decline"></i>
            {/if}
            <i class="sap-icon--search"></i>
          </button>
        </span>
        {/if} {/if}
      </div>
      {#if !isCustomSearchRenderer}
      <div
        class="fd-popover__body fd-popover__body--right luigi-search-popover__body"
        aria-hidden="{!displaySearchResult}"
      >
        <nav class="fd-menu">
          {#if searchResult}
          <ul
            class="fd-menu__list fd-menu__list--top"
            bind:this="{luigiCustomSearchItemRenderer__slotContainer}"
          >
            {#each searchResult as result, index}
            <li
              class="fd-menu__item luigi-search-result-item__{index}"
              on:click="{(event) => onSearchResultItemSelected(result, event)}"
              on:keyup="{(event) => handleKeydown(result, event)}"
              tabindex="0"
            >
              {#if !isCustomSearchResultItemRenderer}
              <a class="fd-menu__link" on:click|preventDefault="{() => {}}">
                <div class="fd-product-switch__text">
                  <div class="fd-product-switch__title">{result.label}</div>
                  <div class="fd-product-switch__subtitle">
                    {result.description}
                  </div>
                </div>
              </a>
              {:else} {@html
              renderCustomSearchItem(result,luigiCustomSearchItemRenderer__slotContainer,
              index)} {/if}
            </li>
            {/each}
          </ul>
          {/if}
        </nav>
      </div>
      {:else}
      <div bind:this="{luigiCustomSearchRenderer__slot}"></div>
      {/if}
    </div>
  </div>
</div>
{#if !isSearchFieldVisible}
<div class="lui-global-search-btn">
  <div on:click|stopPropagation="{() => {}}">
    <button
      class="fd-button fd-shellbar__button"
      aria-haspopup="true"
      aria-expanded="{!isSearchFieldVisible}"
      on:click="{toggleSearch}"
      data-testid="luigi-search-btn-desktop"
    >
      <i class="sap-icon sap-icon--search"></i>
    </button>
  </div>
</div>
{/if}
{#if isSearchFieldVisible}
<div class="lui-global-search-cancel-btn {isSearchFieldVisible?'lui-global-search-cancel-btn--active':''}">
  <div on:click|stopPropagation="{() => {}}">
    <button
      class="fd-button fd-shellbar__button"
      aria-haspopup="true"
      aria-expanded="{!isSearchFieldVisible}"
      on:click="{toggleSearch}"
      data-testid="luigi-search-btn-desktop"
    >
      Cancel
    </button>
  </div>
</div>
{/if}
<script>
  import { beforeUpdate, createEventDispatcher, onMount } from 'svelte';
  import { LuigiAuth, LuigiConfig, LuigiI18N } from '../core-api';
  import { GenericHelpers, GlobalSearchHelper } from '../utilities/helpers';
  import { Routing } from '../services/routing';
  import {
    KEYCODE_ARROW_UP,
    KEYCODE_ARROW_DOWN,
    KEYCODE_ENTER,
    KEYCODE_ESC
  } from '../utilities/keycode.js';
  import { CSS_BREAKPOINTS } from '../utilities/constants';
  let isSearchFieldVisible;
  export let searchResult = [];
  export let displaySearchResult;
  export let displayCustomSearchResult;
  export let isGlobalSearchMobileView;
  export let globalSearchContainerWidth;
  export let inputElem;
  export let luigiCustomSearchRenderer__slot;
  export let luigiCustomSearchItemRenderer__slotContainer;
  export let globalSearchConfig;
  export let isMobile;
  const dispatch = createEventDispatcher();
  const searchApiObj = {
    fireItemSelected: item => {
      search.searchProvider.onSearchResultItemSelected(item);
    }
  };
  let searchResults = {};
  let showPopOverCustomSearch = false;
  let search = {};
  let isCustomSearchRenderer;
  let isCustomSearchResultItemRenderer;
  let clearSearchFieldBtn = false;
  let globalSearchCtnWidth;

  onMount(async () => {
    search = globalSearchConfig;
    let inputElement = inputElem;
    const placeHolder = getSearchPlaceholder(search.searchProvider);
    if (placeHolder) {
      inputElement.placeholder = placeHolder;
    }
    getCustomRenderer();
    globalSearchCtnWidth=GlobalSearchHelper.calculateGlobalSearchCtnWidth();
    globalSearchCtnWidth= parseInt(globalSearchCtnWidth,10)+"px";
    console.log('globalSearchCtnWidth ', globalSearchCtnWidth);
  });

  beforeUpdate(() => {
    search = globalSearchConfig;
    getCustomRenderer();
  });

  function getCustomRenderer() {
    isCustomSearchRenderer = GenericHelpers.isFunction(
      search.searchProvider.customSearchResultRenderer
    );
    isCustomSearchResultItemRenderer = GenericHelpers.isFunction(
      search.searchProvider.customSearchResultItemRenderer
    );
  }

  function getSearchPlaceholder(searchProvider) {
    if (!searchProvider || !searchProvider.inputPlaceholder) {
      return undefined;
    }
    const currentLocale = LuigiI18N.getCurrentLocale();
    if (GenericHelpers.isFunction(searchProvider.inputPlaceholder)) {
      return searchProvider.inputPlaceholder();
    }
    if (typeof searchProvider.inputPlaceholder === 'string') {
      const translated = LuigiI18N.getTranslation(searchProvider.inputPlaceholder);
      if (!!translated && translated.trim().length > 0) {
        return translated;
      }
      return searchProvider.inputPlaceholder;
    }
    if (typeof searchProvider.inputPlaceholder === 'object') {
      return searchProvider.inputPlaceholder[currentLocale];
    }
  }

  function renderCustomSearchItem(item, slotContainer, index) {
    setTimeout(() => {
      search.searchProvider.customSearchResultItemRenderer(
        item,
        slotContainer.children[index],
        searchApiObj
      );
    });
    return '';
  }

  function closeSearchResult() {
    dispatch('closeSearchResult');
  }

  function onKeyUp({ keyCode }) {
    if (search) {
      if (
        GenericHelpers.isFunction(search.searchProvider.onEnter) &&
        keyCode === KEYCODE_ENTER
      ) {
        search.searchProvider.onEnter();
      } else if (
        GenericHelpers.isFunction(search.searchProvider.onEscape) &&
        keyCode === KEYCODE_ESC
      ) {
        search.searchProvider.onEscape();
      } else if (keyCode === KEYCODE_ARROW_DOWN) {
        if (displaySearchResult) {
          document
            .querySelector('.luigi-search-result-item__0')
            .childNodes[0].setAttribute('aria-selected', 'true');
          document.querySelector('.luigi-search-result-item__0').focus();
        }
      } else if (GenericHelpers.isFunction(search.searchProvider.onInput)) {
        search.searchProvider.onInput();
        if (search.searchFieldCentered) {
          document.querySelector('.luigi-search__input').value
            ? (clearSearchFieldBtn = true)
            : (clearSearchFieldBtn = false);
        }
      }
    } else {
      console.warn('GlobalSearch is not available.');
    }
  }

  function clearSearchField() {
    document.querySelector('.luigi-search__input').value = '';
    clearSearchFieldBtn = false;
  }

  function calcSearchResultItemSelected(direction) {
    let renderedSearchResultItems = luigiCustomSearchItemRenderer__slotContainer.children;
    if (renderedSearchResultItems) {
      for (let index = 0; index < renderedSearchResultItems.length; index++) {
        let { childNodes, nextSibling, previousSibling } = renderedSearchResultItems[
          index
        ];
        let nodeSibling;
        if (childNodes[0].getAttribute('aria-selected') === 'true') {
          if (direction === KEYCODE_ARROW_DOWN) {
            nodeSibling =
              nextSibling !== null ? nextSibling : renderedSearchResultItems[0];
          }
          if (direction === KEYCODE_ARROW_UP) {
            nodeSibling =
              previousSibling !== null
                ? previousSibling
                : renderedSearchResultItems[renderedSearchResultItems.length - 1];
          }
          childNodes[0].setAttribute('aria-selected', 'false');
          nodeSibling.childNodes[0].setAttribute('aria-selected', 'true');
          nodeSibling.focus();
          break;
        }
      }
    }
  }

  function clearAriaSelected() {
    let renderedSearchResultItems = luigiCustomSearchItemRenderer__slotContainer.children;
    if (renderedSearchResultItems) {
      for (let index = 0; index < renderedSearchResultItems.length; index++) {
        let element = renderedSearchResultItems[index];
        if (element.childNodes[0].getAttribute('aria-selected') === 'true') {
          element.childNodes[0].setAttribute('aria-selected', 'false');
        }
      }
    }
  }

  function onSearchResultItemSelected(searchResultItem) {
    if (
      search &&
      GenericHelpers.isFunction(search.searchProvider.onSearchResultItemSelected)
    ) {
      search.searchProvider.onSearchResultItemSelected(searchResultItem);
    } else if (
      GenericHelpers.isFunction(search.searchProvider.onEscape) &&
      event.keyCode === KEYCODE_ESC
    ) {
      search.searchProvider.onEscape();
    }
  }

  function handleKeydown(result, { keyCode }) {
    if (keyCode === KEYCODE_ENTER) {
      search.searchProvider.onSearchResultItemSelected(result);
    }
    if (keyCode === KEYCODE_ARROW_UP || keyCode === KEYCODE_ARROW_DOWN) {
      calcSearchResultItemSelected(keyCode);
    } else if (
      GenericHelpers.isFunction(search.searchProvider.onEscape) &&
      keyCode === KEYCODE_ESC
    ) {
      clearAriaSelected();
      setTimeout(() => {
        inputElem.focus();
      });
      search.searchProvider.onEscape();
    }
  }

  export function onActionClick(searchResultItem) {
    let node = searchResultItem.pathObject;
    if (node.externalLink) {
      Routing.navigateToLink(node);
    } else {
      dispatch('handleSearchNavigation', { node });
    }
  }

  function setFocusOnGlobalSearchFieldDesktop() {
    if (inputElem) {
      inputElem.focus();
    }
  }

  function toggleSearch() {
    isSearchFieldVisible=!isSearchFieldVisible;
  }
</script>
<style type="text/scss">
  //remove default browser outline on focus for search results
  .luigi-search-popover__body {
    li[class*='luigi-search-result']:focus {
      outline: none;
    }
  }

  :global(.lui-global-search) {
    order: 2;
    flex: 1;
    max-width: 43rem;
    .fd-popover {
      width: 100%;
    }
  }

  @media (min-width: 1440px) {
    :global(.lui-global-search) {
      margin-left: 3rem;
      margin-right: 3rem;
      
    }
  }

  @media (min-width: 1024px) and (max-width: 1440px) {
    :global(.lui-global-search) {
      margin-left: 2rem;
      margin-right: 2rem;
    }
  }

  @media (min-width: 1023px) and (max-width: 600px) {
    :global(.lui-global-search) {
      margin-left: 1rem;
      margin-right: 1rem;
    }
  }

  :global(.lui-global-search) {
      display:flex;
      justify-content: center;
    }

  :global(.lui-global-search-btn--visible){
    justify-content: flex-end;
    .lui-global-search-btn{
      display:inline-block;
      background-color:red;
    }
  }

  :global(.lui-global-search-input--hidden){
    .lui-global-search-input{
      display:none;
    }
    .lui-global-search-input.lui-global-search-mobile--active{
      position: absolute;
      display:block;
      background-color: #354a5f;
      width: calc(100% - 90px);
      left: 0;
      top: 0;
      z-index: 100000000000000000;
      height: 43px;
      .fd-shellbar__input-group{
        margin-top: 0.2rem;
      }
    }

      .lui-global-search-cancel-btn.lui-global-search-cancel-btn--active{
        position: absolute;
        right: 0;
        display:block;
        display:inline-block;
        background-color: #354a5f;
        top: 0;
        z-index: 999999999999999999;
        width: 90px;
        height: 43px;
        .fd-shellbar__button{
          margin-top: 0.2rem;
        }
      }
      .lui-global-search-btn{
        right:0
      }
  }

  .lui-global-search-btn{
    display:none;
  }

  .lui-global-search-input {
    flex: 0 0 100%;
  }


  @media (max-width: 599px) {
    :global(.lui-global-search) {
      display:flex;
      justify-content: flex-end;
      
      .lui-global-search-mobile--active{
        position: absolute;
        display:block;
        background-color: #354a5f;
        width: calc(100% - 90px);
        left: 0;
        top: 0;
        z-index: 100000000000000000;
        height: 43px;
        .fd-shellbar__input-group{
          margin-top: 0.2rem;
        }
      }
      

      .luigi-search {
        &[aria-hidden='true'] {
        visibility: hidden;
        width: 0;
        }
      }
      .lui-global-search-btn{
        right:0
      }

      .lui-global-search-cancel-btn{
        position: absolute;
        right: 0;
        display:inline-block;
        background-color: #354a5f;
        top: 0;
        width:90px;
        z-index: 999999999999999999;
        .fd-shellbar__button{
          margin-top: 0.2rem;
        }
      }
    }
  }
  :global(.fd-shellbar__group){
    flex-grow: 0;
  }
</style>
