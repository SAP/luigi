<div class="lui-split">
  <div class="splitter" on:dragSplitViewBorder="dragged($event)">
    {#if isCollapsed}
    <a class="lui-collapse-btn" on:click="expand()">
      <span class="sap-icon--collapse-group sap-icon--s"></span>
    </a>
    {:else}
    <a class="lui-collapse-btn" on:click="collapse()">
      <span class="sap-icon--expand-group sap-icon--s"></span>
    </a>
    {/if}
  </div>
  {#if isCollapsed}
  <h1 class="fd-splitView__title">{splitViewSettings.title}</h1>
  {:else}
  <div class="iframeSplitViewCnt"></div>
  {/if}
</div>

<script>
  import { Navigation } from './navigation/services/navigation';
  import { LuigiConfig } from './core-api';
  import { SplitViewSvc } from './services';
  import {
    GenericHelpers,
    IframeHelpers,
    RoutingHelpers
  } from './utilities/helpers';

  const prepareNodeData = async (component, path) => {
    const pathUrlRaw =
      path && path.length ? GenericHelpers.getPathWithoutHash(path) : '';
    const pathData = await Navigation.getNavigationPath(
      LuigiConfig.getConfigValueAsync('navigation.nodes'),
      path
    );
    const params = RoutingHelpers.parseParams(pathUrlRaw.split('?')[1]);
    const nodeParams = RoutingHelpers.getNodeParams(params);
    const lastNode = RoutingHelpers.getLastNodeObject(pathData);
    const splitViewSettings = component.get().splitViewSettings;
    if (!splitViewSettings.title) {
      splitViewSettings.title = lastNode.label;
    }
    const isCollapsed = splitViewSettings.isCollapsed || false;
    console.log('3');
    component.set({
      splitViewSettings,
      lastNode,
      pathData,
      nodeParams,
      isCollapsed,
      isDataPrepared: true
    });
    console.log('4 prepared and set', component.get().splitViewSettings);
  };
  const getNode = async (component, path) => {
    if (component.get().isDataPrepared) {
      if (!component.get().isCollapsed) {
        console.debug('expanded, creating iframe');
        createAndSetSplitView(component);
      } else {
        console.debug('collapsed, not creating iframe');
      }
    } else {
      await prepareNodeData(component, path);
    }
  };
  const createAndSetSplitView = component => {
    const {
      nodeParams,
      lastNode,
      splitViewSettings,
      pathData
    } = component.get();

    const iframe = createIframeSplit(
      lastNode.viewUrl,
      {
        context: pathData.context,
        pathParams: pathData.pathParams,
        nodeParams
      },
      component
    );
    console.log('1');
    component.root.set({
      splitViewIframe: iframe,
      splitViewIframeData: { ...pathData, nodeParams }
    });
    console.log('2');
  };
  const createIframeSplit = (viewUrl, componentData, component) => {
    if (viewUrl) {
      viewUrl = RoutingHelpers.substituteViewUrl(viewUrl, componentData);
    }
    const iframe = IframeHelpers.createIframe(viewUrl);
    const iframeCtn = document.querySelector('.iframeSplitViewCnt');
    iframeCtn.appendChild(iframe);
    return iframe;
  };
  export default {
    onupdate({ changed, current, previous }) {
      const nodepath = this.get().nodepath;
      getNode(this, nodepath);
      if (changed.isCollapsed) {
        console.log('isCollapsed', current.isCollapsed);
      }
    },
    data() {
      return {
        isDataPrepared: false,
        splitViewSettings: {}
      };
    },
    methods: {
      collapse() {
        console.log('collapse!', this.root.get());
        SplitViewSvc.collapseSplitView(this.root);
      },
      expand() {
        SplitViewSvc.expandSplitView(this.root);
      },
      dragged(evt) {
        console.log('evt', evt);
      }
    },
    events: {
      dragSplitViewBorder(node, callback) {
        // console.log('dragSplitViewBorder', node, callback);
        // function onmousedown(event) {
        //   const timeout = setTimeout(() => callback(event), 1000);

        //   function cancel() {
        //     clearTimeout(timeout);
        //     node.removeEventListener('mouseup', cancel, false);
        //   }

        //   node.addEventListener('mouseup', cancel, false);
        // }

        // node.addEventListener('mousedown', onmousedown, false);

        const BORDER_SIZE = 4;
        const panel = node;
        let m_pos;

        function resize(e) {
          const dx = m_pos - e.y;
          m_pos = e.y;

          // panel.style.height = (parseInt(getComputedStyle(panel, '').height) + dx) + "px";
          // console.log('panel.style.height', panel.style.height);
        }
        function onMouseDown(e) {
          if (e.offsetY < BORDER_SIZE) {
            m_pos = e.y;
            document.addEventListener('mousemove', resize, false);
          }
        }
        panel.addEventListener('mousedown', onMouseDown, false);

        document.addEventListener(
          'mouseup',
          function() {
            document.removeEventListener('mousemove', resize, false);
          },
          false
        );

        return {
          destroy() {
            // node.removeEventListener('mousedown', onmousedown, false);
            node.removeEventListener('mousedown', onMouseDown, false);
          }
        };
      }
    }
  };
</script>
<style type="text/scss">
  /* :global(.lui-collapsed) {
    .lui-collapse-btn.col {
      display: none;
    }
    .lui-collapse-btn.exp {
      display: block !important;
    }
  } */
  $collapsedSplitviewHeight: 38px;
  .fd-splitView__title {
    font-size: 16px;
    line-height: $collapsedSplitviewHeight;
    vertical-align: center;
    padding-left: 32px;
    background: #fff;
  }
  .lui-split {
    height: 100%;
    .splitter {
      position: absolute;
      width: 100%;
      top: 0;
      height: 8px;
      border-top: 2px solid gray;
      background: transparent;
      cursor: row-resize;
      z-index: 1;
      .lui-collapse-btn {
        width: 25px;
        height: 25px;
        background: white;
        position: absolute;
        left: 50%;
        z-index: 1;
        margin-left: -12px;
        margin-top: -12px;
        text-align: center;
        padding: 3px;
        border: 1px solid gray;
        border-radius: 5px;
        cursor: pointer;
        visibility: hidden;
      }
      &:hover {
        .lui-collapse-btn {
          visibility: visible;
        }
      }
    }
    .iframeSplitViewCnt {
      position: absolute;
      width: 100%;
      bottom: 0;
      top: 2px;
    }
    .iframeSplitViewCnt :global(iframe) {
      width: 100%;
      height: 100%;
      border: 0;
      position: absolute;
    }
  }
</style>
