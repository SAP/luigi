<svelte:window on:resize="onResize()"/>
<div class="lui-split-view">
  {#if isCollapsed}
  <div class="splitViewSeparator isCollapsed">
    <a class="lui-collapse-btn" on:click="expand(event)">
      <span class="sap-icon--collapse-group sap-icon--s"></span>
    </a>
  </div>
  <h1 class="fd-splitView__title">{splitViewSettings.title}</h1>
  {:else}
  <div id="splitViewDragger" on:dragSplitViewBorder="dragged(event)">
    <div class="splitViewSeparator"></div>
    <a class="lui-collapse-btn" on:click="collapse(event)">
      <span class="sap-icon--expand-group sap-icon--s"></span>
    </a>
  </div>
  <div id="splitViewDraggerBackdrop"></div>
  <div class="iframeSplitViewCnt"></div>
  {/if}
</div>

<script>
    import { LuigiElements } from './core-api';
    import { Iframe, SplitViewSvc } from './services';
    import {
      GenericHelpers,
      IframeHelpers,
      RoutingHelpers
    } from './utilities/helpers';

    let rightContentHeight, thresholdTop, thresholdBottom;

    const getNode = async (component, path) => {
      if (component.get().isDataPrepared) {
        if (!component.get().isCollapsed) {
          SplitViewSvc.createAndSetSplitView(component);
        }
      } else {
        await SplitViewSvc.prepareSplitViewData(component, path);
      }
    };

    const registerEventHandlers = async e => {
      const iframe = IframeHelpers.getValidMessageSource(e, this.root);
      if (!iframe) return;

      // actions, like collapse, expand, setSize as well as register
      // event handlers: onCollapse, onExpand, onResize
      // status info like exists, getSize, isCollapsed
      if ('luigi.navigation.splitview.collapse' === e.data.msg) {
        console.log(e.data.msg);
        this.collapse();
      }
      if ('luigi.navigation.splitview.expand' === e.data.msg) {
        console.log(e.data.msg);
        this.expand();
      }
      if ('luigi.navigation.splitview.set-size' === e.data.msg) {
        console.log(e.data.msg, e.data);

      }
    });
  };

    export default {
      oncreate() {
        this.onResize();
        this.registerEventHandlers();
      },
      onupdate({ changed, current, previous }) {
        getNode(this, this.get().nodepath);
      },
      data() {
        return {
          isDataPrepared: false,
          splitViewSettings: {}
        };
      },
      methods: {
        collapse(evt) {
          evt.stopPropagation();
          SplitViewSvc.collapseSplitView(this.root);
        },
        expand(evt) {
          evt.stopPropagation();
          SplitViewSvc.expandSplitView(this.root);
          SplitViewSvc.getSplitViewDraggerBackdrop().style.display = 'none';
        },
        onResize() {
          const shellbarHeight = LuigiElements.getShellbar().clientHeight;
          rightContentHeight = window.innerHeight - shellbarHeight;
          thresholdBottom = 30;
          thresholdTop = shellbarHeight + 30;
        },
        registerEventHandlers() {
          window.addEventListener('message', registerEventHandlers);
        }
      },
      events: {
        dragSplitViewBorder(dragElem) {
          let m_pos, top, bottom, splitElement, draggableElement;
          const dragBorderSize = 30; // #splitViewDragger height

          const iframeElement = Iframe.getIframeContainer();

          const resize = e => {
            const diff = m_pos - e.y;
            m_pos = e.y;

            if (!draggableElement) {
              draggableElement = SplitViewSvc.getSplitViewDragger();
            }
            const dragTop = parseInt(getComputedStyle(draggableElement, '').top);
            top = dragTop - diff;
            bottom = window.innerHeight - top;

            if (top <= thresholdTop) {
              top = thresholdTop;
              bottom = window.innerHeight - thresholdTop;
            } else if (bottom <= thresholdBottom) {
              top = window.innerHeight - thresholdBottom;
              bottom = thresholdBottom;
            }

            draggableElement.style.top = `${top}px`;
          };

          function onMouseDown(e) {
            if (e.offsetY < dragBorderSize) {
              m_pos = e.y;
              SplitViewSvc.getSplitViewDraggerBackdrop().style.display = 'block';
              document.addEventListener('mousemove', resize, false);
            }
          }
          dragElem.addEventListener('mousedown', onMouseDown, false);

          document.addEventListener(
            'mouseup',
            function() {
              if (!splitElement) {
                splitElement = SplitViewSvc.getSplitViewContainer();
              }
              const draggerBackdrop = SplitViewSvc.getSplitViewDraggerBackdrop();
              if (draggerBackdrop) {
                draggerBackdrop.style.display = 'none';
              }

              SplitViewSvc.splitViewValues = { top, bottom };
              splitElement.style.top = `${top}px`;
              iframeElement.style.paddingBottom = `${bottom}px`;
              document.removeEventListener('mousemove', resize, false);
            },
            false
          );

          return {
            destroy() {
              dragElem.removeEventListener('mousedown', onMouseDown, false);
              window.removeEventListener('message', registerEventHandlers, false);
            }
          };
        }
      }
    };
</script>
<style type="text/scss">
  $topNavHeight: 48px;
  $leftNavWidth: 320px;
  $collapsedSplitviewHeight: 38px;
  .fd-splitView__title {
    font-size: 16px;
    line-height: $collapsedSplitviewHeight;
    vertical-align: center;
    padding-left: 32px;
    background: #fff;
  }

  #splitViewDragger {
    position: fixed;
    bottom: 0;
    right: 0;
    left: $leftNavWidth;
    top: 60%; /* default, overridden by computed.getIframeSplitViewTop */
    height: 8px;
    z-index: 2;
    cursor: row-resize;
    &:hover {
      /* enlarge mouse move target */
      margin-top: -15px;
      padding-top: 15px;
      padding-bottom: 15px;

      .lui-collapse-btn {
        visibility: visible;
      }
    }
  }

  .splitViewSeparator {
    border-top: 2px gray solid;
  }

  .lui-collapse-btn {
    width: 25px;
    height: 25px;
    background: white;
    position: absolute;
    left: 50%;
    z-index: 1;
    margin-left: -12px;
    margin-top: -12px;
    text-align: center;
    padding: 3px;
    border: 1px solid gray;
    border-radius: 5px;
    cursor: pointer;
    visibility: hidden;
  }

  #splitViewDraggerBackdrop {
    position: fixed;
    background-color: rgba(255, 255, 255, 0.7);
    top: $topNavHeight;
    right: 0;
    bottom: 0;
    left: $leftNavWidth;
    z-index: 1;
    display: none;
  }

  .lui-split-view {
    height: 100%;

    .splitViewSeparator.isCollapsed {
      position: absolute;
      width: 100%;
      top: 0;
      margin-bottom: 4px;

      &:hover .lui-collapse-btn {
        visibility: visible;
      }
    }

    .iframeSplitViewCnt {
      background-color: var(--fd-background-color);
      position: absolute;
      width: 100%;
      bottom: 0;
      top: 2px;
    }
    .iframeSplitViewCnt :global(iframe) {
      width: 100%;
      height: 100%;
      border: 0;
      position: absolute;
    }
  }
</style>
