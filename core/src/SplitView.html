<svelte:window on:resize="onResize()"/>
<div class="lui-split-view">
  {#if collapsed}
  <div class="splitViewSeparator isCollapsed">
    <a class="lui-collapse-btn" on:click:stopPropagation="expand(event)">
      <span class="sap-icon--collapse-group sap-icon--s"></span>
    </a>
  </div>
  <h1 class="fd-splitView__title">{splitViewSettings.title}</h1>
  {:else}
  <div id="splitViewDragger" on:dragSplitViewBorder="dragged(event)">
    <div class="splitViewSeparator"></div>
    <a class="lui-collapse-btn" on:click:stopPropagation="collapse(event)">
      <span class="sap-icon--expand-group sap-icon--s"></span>
    </a>
  </div>
  <div id="splitViewDraggerBackdrop"></div>
  <div class="iframeSplitViewCnt"></div>
  {/if}
</div>

<script>
  import { LuigiElements } from './core-api';
  import { Iframe, SplitViewSvc } from './services';
  import {
    GenericHelpers,
    IframeHelpers,
    RoutingHelpers
  } from './utilities/helpers';

  let values = {
    rightContentHeight: null,
    thresholdTop: null,
    thresholdBottom: null
  };
  let elements = {
    draggable: null,
    iframe: null,
    split: null
  };
  let splitStyles = {
    top: null,
    bottom: null,
    percent: null
  };

  const getNode = async (component, path) => {
    if (component.get().isDataPrepared) {
      if (!component.get().collapsed) {
        SplitViewSvc.createAndSetView(component);
      }
    } else {
      await SplitViewSvc.prepareSplitViewData(component, path);
    }
  };

  const setElements = () => {
    if (!elements.split) {
      elements.split = SplitViewSvc.getContainer();
    }
    if (!elements.iframe) {
      elements.iframe = Iframe.getIframeContainer();
    }
    elements.draggable = SplitViewSvc.getDragger();
  };

  const setSplitViewSize = () => {
    const draggerBackdrop = SplitViewSvc.getDraggerBackdrop();
    if (draggerBackdrop) {
      draggerBackdrop.style.display = 'none';
    }

    setElements();
    // setting again, to be sure its positioned when using it programmatically
    if (elements.draggable) {
      elements.draggable.style.top = `${splitStyles.top}px`;
    }

    SplitViewSvc.splitViewValues = {
      top: splitStyles.top,
      bottom: splitStyles.bottom,
      percent: splitStyles.percent
    };
    elements.split.style.top = `${splitStyles.top}px`;
    elements.iframe.style.paddingBottom = `${splitStyles.bottom}px`;
  };

  function messageHandler(e) {
    const iframe = IframeHelpers.getValidMessageSource(e, this.root);
    if (!iframe) return;

    // actions, like collapse, expand, setSize as well as register
    // event handlers: onCollapse, onExpand, onResize

    if ('luigi.navigation.splitview.close' === e.data.msg) {
      SplitViewSvc.close(this.root);
    }
    if ('luigi.navigation.splitview.collapse' === e.data.msg) {
      this.collapse();
    }
    if ('luigi.navigation.splitview.expand' === e.data.msg) {
      this.expand();
    }
    if ('luigi.navigation.splitview.resize' === e.data.msg) {
      splitStyles.percent = parseInt(e.data.data);
      const percentTop = 100 - splitStyles.percent;
      const newTop =
        parseInt(
          GenericHelpers.computePxFromPercent(
            values.rightContentHeight,
            percentTop
          )
        ) + LuigiElements.getShellbar().clientHeight;

      const calculated = SplitViewSvc.enforceTreshHolds(
        newTop,
        window.innerHeight - newTop,
        values.thresholdTop,
        values.thresholdBottom
      );
      splitStyles.top = calculated.top;
      splitStyles.bottom = calculated.bottom;

      // In case setSize gets called before expanding, we're setting
      // the stored split view values
      if (this.get().collapsed) {
        SplitViewSvc.storedSplitViewValues = {
          top: splitStyles.top,
          bottom: splitStyles.bottom,
          percent: splitStyles.percent
        };
        return;
      }
      setSplitViewSize();
      SplitViewSvc.sendMessageToClients('resize.ok', splitStyles.percent);
    }
  }

  export default {
    oncreate() {
      this.onResize();
      window.addEventListener('message', messageHandler.bind(this));
    },
    onupdate({ changed, current, previous }) {
      getNode(this, this.get().nodepath);
    },
    ondestroy() {
      window.removeEventListener('message', messageHandler.bind(this));
    },
    data() {
      return {
        isDataPrepared: false,
        splitViewSettings: {}
      };
    },
    methods: {
      collapse() {
        SplitViewSvc.collapse(this.root);
      },
      expand() {
        SplitViewSvc.expand(this.root);
        SplitViewSvc.getDraggerBackdrop().style.display = 'none';
      },
      onResize() {
        const shellbarHeight = LuigiElements.getShellbar().clientHeight;
        values.rightContentHeight = window.innerHeight - shellbarHeight;
        values.thresholdBottom = 30;
        values.thresholdTop = shellbarHeight + 30;
      }
    },
    events: {
      dragSplitViewBorder(dragElem) {
        let m_pos;
        const dragBorderSize = 30; // #splitViewDragger height

        const resize = e => {
          const diff = m_pos - e.y;
          m_pos = e.y;

          const dragTop = parseInt(
            getComputedStyle(elements.draggable, '').top
          );
          if (isNaN(dragTop)) {
            // happens in collapsed state on mouse over draggable
            return;
          }

          const newTop = dragTop - diff;
          const newBottom = window.innerHeight - newTop;
          const calculated = SplitViewSvc.enforceTreshHolds(
            newTop,
            newBottom,
            values.thresholdTop,
            values.thresholdBottom
          );

          splitStyles.top = calculated.top;
          splitStyles.bottom = calculated.bottom;

          elements.draggable.style.top = `${splitStyles.top}px`;
        };

        function onMouseDown(e) {
          if (e.offsetY < dragBorderSize) {
            setElements();
            m_pos = e.y;
            SplitViewSvc.getDraggerBackdrop().style.display = 'block';
            document.addEventListener('mousemove', resize, false);
          }
        }
        dragElem.addEventListener('mousedown', onMouseDown, false);

        function onMouseUp() {
          if (!splitStyles.top || !splitStyles.bottom) {
            return;
          }

          setSplitViewSize();
          splitStyles.percent = GenericHelpers.computePercentFromPx(
            values.rightContentHeight,
            splitStyles.bottom
          );
          SplitViewSvc.sendMessageToClients('resize.ok', splitStyles.percent);
          document.removeEventListener('mousemove', resize, false);
        }

        document.removeEventListener('mouseup', onMouseUp, false);
        document.addEventListener('mouseup', onMouseUp, false);

        return {
          destroy() {
            dragElem.removeEventListener('mousedown', onMouseDown, false);
            document.removeEventListener('mouseup', onMouseUp, false);
          }
        };
      }
    }
  };
</script>
<style type="text/scss">
  $topNavHeight: 48px;
  $leftNavWidth: 320px;
  $collapsedSplitviewHeight: 38px;
  $desktopMinWidth: 600px;

  .fd-splitView__title {
    font-size: 16px;
    line-height: $collapsedSplitviewHeight;
    vertical-align: center;
    padding-left: 32px;
    background: #fff;
  }

  #splitViewDragger {
    position: fixed;
    bottom: 0;
    right: 0;
    left: $leftNavWidth;
    top: 60%; /* default, overridden by computed.getIframeSplitViewTop */
    height: 8px;
    z-index: 2;
    cursor: row-resize;
    &:hover {
      /* enlarge mouse move target */
      margin-top: -15px;
      padding-top: 15px;
      padding-bottom: 15px;

      .lui-collapse-btn {
        visibility: visible;
      }
    }
  }

  .splitViewSeparator {
    border-top: 2px gray solid;
    &.isCollapsed {
      padding-bottom: 15px;
    }
  }

  .lui-collapse-btn {
    width: 25px;
    height: 25px;
    background: white;
    position: absolute;
    left: 50%;
    z-index: 1;
    margin-left: -12px;
    margin-top: -12px;
    text-align: center;
    padding: 3px;
    border: 1px solid gray;
    border-radius: 5px;
    cursor: pointer;
    visibility: hidden;
  }

  #splitViewDraggerBackdrop {
    position: fixed;
    background-color: rgba(255, 255, 255, 0.7);
    top: $topNavHeight;
    right: 0;
    bottom: 0;
    left: $leftNavWidth;
    z-index: 1;
    display: none;
  }

  .lui-split-view {
    height: 100%;

    .splitViewSeparator.isCollapsed {
      position: absolute;
      width: 100%;
      top: 0;
      margin-bottom: 4px;

      &:hover .lui-collapse-btn {
        visibility: visible;
      }
    }

    .iframeSplitViewCnt {
      background-color: var(--fd-background-color);
      position: absolute;
      width: 100%;
      bottom: 0;
      top: 2px;
    }
    .iframeSplitViewCnt :global(iframe) {
      width: 100%;
      height: 100%;
      border: 0;
      position: absolute;
    }
  }

  @media (max-width: $desktopMinWidth - 1) {
    :global(body.lui-simpleSlideInNav) {
      :global(.fd-app__sidebar) {
        left: -$leftNavWidth;
      }
      :global(#splitViewContainer, #splitViewDragger, #splitViewDraggerBackdrop) {
        left: 0 !important;
      }
    }
  }
</style>
