<body>
  <script type="text/javascript">
    const winParent = window.parent;
    const targetOrigin = winParent.origin !== 'null' ? winParent.origin : '*';
    const luigiCookieValue = 'luigiCookie=true';
    const sanitizeString = input =>
      input ? input.replace(/[^a-z0-9%._=;]/gim, '') : '';
    const getLuigiCookie = cookies =>
      cookies
        .split(';')
        .map(cookie => sanitizeString(cookie))
        .find(cookie => cookie === luigiCookieValue);
    let cookies = sanitizeString(document.cookie);
    let tpc = 'enabled';
    let luigiCookie;
    let luigiCookieKey;

    if (cookies) {
      luigiCookie = getLuigiCookie(cookies);
    }
    if (luigiCookie === luigiCookieValue) {
      luigiCookieKey = luigiCookieValue.split('=')[0];
      document.cookie = luigiCookieKey + '=; Max-Age=-99999999; SameSite=None; Secure';
    }

    document.cookie = luigiCookieValue + '; SameSite=None; Secure';
    cookies = sanitizeString(document.cookie);

    if (cookies) {
      luigiCookie = getLuigiCookie(cookies);
    }
    if (luigiCookie !== luigiCookieValue) {
      tpc = 'disabled';
      console.warn('Third party cookies are not supported!');
    }

    winParent.postMessage({ msg: 'luigi.third-party-cookie', tpc }, targetOrigin);
  </script>
</body>
